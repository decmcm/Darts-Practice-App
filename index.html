<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darts 501 Practice</title>

    <!-- PWA: Link to the Manifest file -->
    <link rel="manifest" href="manifest.json">
    <!-- PWA: Theme color for browser UI (and iOS status bar) -->
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
        }
        .keypad-btn {
            @apply rounded-lg bg-gray-700 p-5 text-2xl font-semibold text-white shadow-md transition-transform duration-100 active:scale-95 active:bg-gray-600;
        }
        .action-btn {
            @apply rounded-lg p-5 text-xl font-bold text-white shadow-md transition-transform duration-100 active:scale-95;
        }
        .tab-btn {
            @apply w-full pb-3 text-center font-semibold text-gray-400 border-b-4 border-transparent;
        }
        .tab-btn.active {
            @apply text-yellow-400 border-yellow-400;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full overflow-hidden">

    <!-- Main App Container -->
    <div class="max-w-md mx-auto h-full flex flex-col">

        <!-- Header Tabs -->
        <nav class="flex justify-between items-center bg-gray-800 shadow-lg sticky top-0 z-10">
            <div class="flex justify-around flex-grow">
                <button id="tab-game" class="tab-btn active" data-view="game">Game</button>
                <button id="tab-stats" class="tab-btn" data-view="stats">Stats</button>
            </div>
            <button id="fullscreen-btn" class="p-3 text-gray-400 hover:text-white transition-colors flex-shrink-0" title="Toggle Fullscreen">
                <svg id="fs-icon-expand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9M20.25 20.25v-4.5m0 4.5h-4.5m4.5 0L15 15" />
                </svg>
                <svg id="fs-icon-collapse" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 hidden">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L4.5 4.5M9 15v4.5M9 15H4.5M9 15l-4.5 4.5M15 9V4.5M15 9h4.5M15 9l4.5-4.5M15 15v4.5M15 15h4.5M15 15l4.5 4.5" />
                </svg>
            </button>
        </nav>

        <!-- ======================= -->
        <!-- ===== GAME VIEW ===== -->
        <!-- ======================= -->
        <main id="game-view" class="flex-grow flex flex-col p-4 overflow-y-auto">
            
            <!-- Mode Selector -->
            <div class="mb-4">
                <label for="game-mode" class="block text-sm font-medium text-gray-300 mb-1">Game Mode</label>
                <select id="game-mode" class="w-full bg-gray-700 text-white rounded-lg p-3 border-0">
                    <option value="501">Practice 501</option>
                    <option value="bot-50">vs. Bot (50 Avg)</option>
                    <option value="bot-65">vs. Bot (65 Avg)</option>
                    <option value="bot-80">vs. Bot (80 Avg)</option>
                    <option value="bot-custom">vs. Bot (Custom Avg)</option>
                    <option value="checkout">Checkout Practice</option>
                    <option value="atc">Around The Clock (Doubles)</option>
                    <option value="bobs27">Bob's 27</option>
                </select>
            </div>

            <!-- Bot AI Average Input (Future use) -->
            <div id="bot-avg-container" class="hidden mb-4">
                <label for="bot-avg" class="block text-sm font-medium text-gray-300 mb-1">Bot Target Average</label>
                <input type="number" id="bot-avg" value="65" class="w-full bg-gray-700 text-white rounded-lg p-3 border-0">
            </div>

            <!-- Session Stats -->
            <div class="bg-gray-800 rounded-lg p-3 mb-4 shadow-md">
                <h3 class="text-lg font-semibold text-yellow-400 mb-2">Session Stats</h3>
                <div class="grid grid-cols-4 gap-2 text-center">
                    <div>
                        <div class="text-xs text-gray-400">Avg</div>
                        <div id="session-avg" class="text-xl font-bold">0.00</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">Legs</div>
                        <div id="session-legs" class="text-xl font-bold">0</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">Best Leg</div>
                        <div id="session-best" class="text-xl font-bold">-</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">Checkout %</div>
                        <div id="session-checkout-pct" class="text-xl font-bold">0%</div>
                    </div>
                </div>
            </div>

            <!-- Score Display -->
            <div id="score-display" class="flex-grow flex flex-col justify-center text-center">
                <!-- Player Score -->
                <div id="player-score-container" class="mb-2">
                    <div class="text-sm text-gray-400" id="player-label">YOU</div>
                    <div id="player-score" class="text-8xl font-bold text-yellow-400" style="line-height: 1;">501</div>
                    <div id="player-checkout" class="text-lg text-green-300 h-6"></div>
                    <div id="player-bogey" class="text-sm text-red-500 font-semibold h-5"></div>
                </div>
                
                <!-- Bot Score (Hidden by default) -->
                <div id="bot-score-container" class="hidden mb-2">
                    <div class="text-sm text-gray-400" id="bot-label">BOT (65 Avg)</div>
                    <div id="bot-score" class="text-6xl font-bold text-gray-500" style="line-height: 1;">501</div>
                </div>

                <!-- Game Mode Specific Display -->
                <div id="game-mode-display" class="text-center">
                    <div id="checkout-practice-display" class="hidden">
                        <div class="text-lg text-gray-300">Target Checkout</div>
                        <div id="checkout-target" class="text-6xl font-bold text-yellow-400">121</div>
                        <div id="checkout-darts-thrown" class="text-lg">Darts Thrown: 0</div>
                    </div>
                    <div id="atc-display" class="hidden">
                        <div class="text-lg text-gray-300">Target</div>
                        <div id="atc-target" class="text-6xl font-bold text-yellow-400">D1</div>
                        <div id="atc-darts" class="text-lg">Total Darts: 0</div>
                    </div>
                    <div id="bobs27-display" class="hidden">
                        <div class="text-lg text-gray-300">Current Score / Target</div>
                        <div id="bobs27-score" class="text-6xl font-bold text-yellow-400">27</div>
                        <div id="bobs27-target" class="text-4xl font-bold text-gray-400">D1</div>
                        <div class="text-sm text-gray-300 mt-2">Enter darts hit (0-3)</div>
                    </div>
                </div>

                <!-- Leg Stats -->
                <div id="leg-stats-container" class="mt-4">
                    <div class="flex justify-around text-center">
                        <div>
                            <div class="text-xs text-gray-400">Leg Avg</div>
                            <div id="leg-avg" class="text-2xl font-bold">0.00</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">Darts</div>
                            <div id="leg-darts" class="text-2xl font-bold">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leg Score History -->
            <div id="leg-history-container" class="h-24 overflow-y-auto bg-gray-800 rounded-lg p-2 mt-4 text-sm text-gray-300">
                <ul id="leg-history-list">
                    <!-- Scores added here -->
                </ul>
            </div>
        </main>

        <!-- ====================== -->
        <!-- ===== STATS VIEW ===== -->
        <!-- ====================== -->
        <main id="stats-view" class="hidden flex-grow p-4 overflow-y-auto">
            <h2 class="text-2xl font-semibold text-yellow-400 mb-4">Improvement Stats</h2>

            <!-- Dashboard -->
            <div class="bg-gray-800 rounded-lg p-3 mb-4 shadow-md">
                <h3 class="text-lg font-semibold text-gray-100 mb-2">Personal Bests</h3>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <div class="text-xs text-gray-400">Best Leg</div>
                        <div id="best-leg" class="text-xl font-bold">-</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">Best Session</div>
                        <div id="best-session" class="text-xl font-bold">0.00</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">Total 180s</div>
                        <div id="total-180s" class="text-xl font-bold">0</div>
                    </div>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="bg-gray-800 rounded-lg p-3 mb-4 shadow-md">
                <h3 class="text-lg font-semibold text-gray-100 mb-2">Progress Over Time</h3>
                <canvas id="stats-chart"></canvas>
            </div>

            <!-- Session History Table -->
            <div class="bg-gray-800 rounded-lg p-3 mb-4 shadow-md">
                <h3 class="text-lg font-semibold text-gray-100 mb-2">Session History</h3>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="sticky top-0 bg-gray-800">
                            <tr>
                                <th class="py-1">Date</th>
                                <th class="py-1">Avg</th>
                                <th class="py-1">Best</th>
                                <th class="py-1">Checkout %</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="text-gray-300">
                            <!-- History rows added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <button id="clear-history-btn" class="w-full bg-red-600 active:bg-red-500 text-white font-bold py-3 rounded-lg shadow-md">
                Clear All History
            </button>
        </main>

        <!-- ========================= -->
        <!-- ===== KEYPAD & NAV ===== -->
        <!-- ========================= -->
        <footer class="sticky bottom-0 bg-gray-800 p-2 shadow-inner">
            <div class="max-w-md mx-auto">
                <div class="flex items-center mb-2 px-2">
                    <div id="keypad-display" class="flex-grow bg-gray-900 text-white text-3xl font-bold rounded-lg p-3 text-right h-16"></div>
                    <button id="keypad-clear" class="ml-2 keypad-btn flex-shrink-0 px-5">C</button>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <button class="keypad-btn" data-key="1">1</button>
                    <button class="keypad-btn" data-key="2">2</button>
                    <button class="keypad-btn" data-key="3">3</button>
                    <button class="keypad-btn" data-key="4">4</button>
                    <button class="keypad-btn" data-key="5">5</button>
                    <button class="keypad-btn" data-key="6">6</button>
                    <button class="keypad-btn" data-key="7">7</button>
                    <button class="keypad-btn" data-key="8">8</button>
                    <button class="keypad-btn" data-key="9">9</button>
                    <button id="keypad-undo" class="action-btn bg-blue-600 text-lg">UNDO</button>
                    <button class="keypad-btn" data-key="0">0</button>
                    <button id="keypad-bust" class="action-btn bg-red-600 text-lg">BUST</button>
                </div>
                <button id="keypad-enter" class="action-btn bg-green-600 w-full text-2xl">ENTER</button>
            </div>
        </footer>

    </div> <!-- End Main App Container -->

    <!-- ================== -->
    <!-- ===== MODALS ===== -->
    <!-- ================== -->

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-semibold text-yellow-400 mb-4">Leg Complete!</h3>
            <div id="checkout-leg-darts" class="text-lg mb-4"></div>
            <label for="darts-at-double" class="block text-sm font-medium text-gray-300 mb-2">How many darts at a double?</label>
            <input type="number" id="darts-at-double" class="w-full bg-gray-700 text-white rounded-lg p-3 border-0 text-lg" min="1" max="3" value="1">
            <button id="save-checkout-btn" class="mt-4 w-full bg-green-600 active:bg-green-500 text-white font-bold py-3 rounded-lg shadow-md">
                Save Leg
            </button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h3 id="game-over-title" class="text-2xl font-semibold text-yellow-400 mb-4">Game Over!</h3>
            <p id="game-over-message" class="text-lg mb-6"></p>
            <button id="game-over-ok-btn" class="w-full bg-green-600 active:bg-green-500 text-white font-bold py-3 rounded-lg shadow-md">
                New Game
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM Elements ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const views = {
                game: $('#game-view'),
                stats: $('#stats-view'),
            };
            const tabs = {
                game: $('#tab-game'),
                stats: $('#tab-stats'),
            };
            const displays = {
                keypad: $('#keypad-display'),
                playerScore: $('#player-score'),
                playerCheckout: $('#player-checkout'),
                playerBogey: $('#player-bogey'),
                playerLabel: $('#player-label'),
                botScore: $('#bot-score'),
                botLabel: $('#bot-label'),
                botContainer: $('#bot-score-container'),
                legAvg: $('#leg-avg'),
                legDarts: $('#leg-darts'),
                sessionAvg: $('#session-avg'),
                sessionLegs: $('#session-legs'),
                sessionBest: $('#session-best'),
                sessionCheckoutPct: $('#session-checkout-pct'),
                legHistoryList: $('#leg-history-list'),
                gameModeSelect: $('#game-mode'),
                // Mode-specific displays
                scoreDisplay: $('#score-display'),
                playerScoreContainer: $('#player-score-container'),
                legStatsContainer: $('#leg-stats-container'),
                legHistoryContainer: $('#leg-history-container'),
                checkoutPracticeDisplay: $('#checkout-practice-display'),
                checkoutTarget: $('#checkout-target'),
                checkoutDartsThrown: $('#checkout-darts-thrown'),
                atcDisplay: $('#atc-display'),
                atcTarget: $('#atc-target'),
                atcDarts: $('#atc-darts'),
                bobs27Display: $('#bobs27-display'),
                bobs27Score: $('#bobs27-score'),
                bobs27Target: $('#bobs27-target'),
                // Stats page
                bestLeg: $('#best-leg'),
                bestSession: $('#best-session'),
                total180s: $('#total-180s'),
                historyTableBody: $('#history-table-body'),
                // Modals
                checkoutModal: $('#checkout-modal'),
                checkoutLegDarts: $('#checkout-leg-darts'),
                dartsAtDoubleInput: $('#darts-at-double'),
                saveCheckoutBtn: $('#save-checkout-btn'),
                gameOverModal: $('#game-over-modal'),
                gameOverTitle: $('#game-over-title'),
                gameOverMessage: $('#game-over-message'),
                gameOverOkBtn: $('#game-over-ok-btn'),
                // Buttons
                keypadEnter: $('#keypad-enter'),
                keypadBust: $('#keypad-bust'),
                keypadUndo: $('#keypad-undo')
            };

            // --- Checkout & Bogey Data ---
            const bogeyNumbers = [169, 168, 166, 165, 163, 162, 159];
            const checkoutTable = {
                170: "T20, T20, Bull", 167: "T20, T19, Bull", 164: "T20, T18, Bull", 161: "T20, T17, Bull", 160: "T20, T20, D20",
                158: "T20, T20, D19", 157: "T20, T19, D20", 156: "T20, T20, D18", 155: "T20, T19, D19", 154: "T20, T18, D20",
                153: "T20, T19, D18", 152: "T20, T20, D16", 151: "T20, T17, D20", 150: "T20, T18, D18", 149: "T20, T19, D16",
                148: "T20, T16, D20", 147: "T20, T17, D18", 146: "T20, T18, D16", 145: "T20, T15, D20", 144: "T20, T20, D12",
                143: "T20, T17, D16", 142: "T20, T14, D20", 141: "T20, T19, D12", 140: "T20, T20, D10", 139: "T20, T13, D20",
                138: "T20, T18, D12", 137: "T20, T17, D13", 136: "T20, T20, D8", 135: "T20, T15, D15", 134: "T20, T14, D16",
                133: "T20, T19, D8", 132: "T20, T16, D12", 131: "T20, T13, D16", 130: "T20, T20, D5", 129: "T19, T16, D12",
                128: "T18, T14, D16", 127: "T20, T17, D8", 126: "T19, T19, D6", 125: "Bull, T15, D15", 124: "T20, T16, D8",
                123: "T19, T16, D9", 122: "T18, T20, D4", 121: "T20, T11, D14", 120: "T20, 20, D20", 119: "T19, T12, D13",
                118: "T20, 18, D20", 117: "T20, 17, D20", 116: "T20, 16, D20", 115: "T20, 15, D20", 114: "T20, 14, D20",
                113: "T20, 13, D20", 112: "T20, 12, D20", 111: "T20, 11, D20", 110: "T20, 10, D20", 109: "T19, 12, D20",
                108: "T19, 11, D20", 107: "T19, 10, D20", 106: "T20, 6, D20", 105: "T20, 5, D20", 104: "T18, 10, D20",
                103: "T19, 6, D20", 102: "T20, 2, D20", 101: "T17, 10, D20", 100: "T20, D20", 99: "T19, D21", 98: "T20, D19",
                97: "T19, D20", 96: "T20, D18", 95: "T19, D19", 94: "T18, D20", 93: "T19, D18", 92: "T20, D16",
                91: "T17, D20", 90: "T20, D15", 89: "T19, D16", 88: "T20, D14", 87: "T17, D18", 86: "T18, D16",
                85: "T15, D20", 84: "T20, D12", 83: "T17, D16", 82: "T14, D20", 81: "T19, D12", 80: "T20, D10",
                79: "T13, D20", 78: "T18, D12", 77: "T19, D10", 76: "T20, D8", 75: "T17, D12", 74: "T14, D16",
                73: "T19, D8", 72: "T16, D12", 71: "T13, D16", 70: "T20, D5", 69: "T19, D6", 68: "T20, D4",
                67: "T17, D8", 66: "T10, D18", 65: "T19, D4", 64: "T16, D8", 63: "T13, D12", 62: "T10, D16",
                61: "T15, D8", 60: "20, D20", 59: "19, D20", 58: "18, D20", 57: "17, D20", 56: "16, D20",
                55: "15, D20", 54: "14, D20", 53: "13, D20", 52: "12, D20", 51: "11, D20", 50: "10, D20",
                49: "9, D20", 48: "8, D20", 47: "15, D16", 46: "6, D20", 45: "13, D16", 44: "4, D20",
                43: "3, D20", 42: "10, D16", 41: "9, D16", 40: "D20", 39: "7, D16", 38: "D19", 37: "5, D16",
                36: "D18", 35: "3, D16", 34: "D17", 33: "1, D16", 32: "D16", 31: "15, D8", 30: "D15",
                29: "13, D8", 28: "D14", 27: "11, D8", 26: "D13", 25: "9, D8", 24: "D12", 23: "7, D8",
                22: "D11", 21: "5, D8", 20: "D10", 19: "3, D8", 18: "D9", 17: "1, D8", 16: "D8",
                15: "7, D4", 14: "D7", 13: "5, D4", 12: "D6", 11: "3, D4", 10: "D5", 9: "1, D4",
                8: "D4", 7: "S3, D2", 6: "D3", 5: "S1, D2", 4: "D2", 3: "S1, D1", 2: "D1"
            };

            // --- App State ---
            let state = {
                currentView: 'game',
                gameMode: '501', // '501', 'bot-50', 'bot-65', 'bot-80', 'checkout', 'atc', 'bobs27'
                keypadBuffer: '',
                player: null,
                bot: null,
                session: null,
                history: [],
                lastTurn: null, // For undo
                checkoutPractice: null,
                atc: null,
                bobs27: null,
                stats: null,
                chart: null,
            };

            // --- Utility Functions ---
            const utils = {
                save: () => {
                    localStorage.setItem('dartsHistory', JSON.stringify(state.history));
                    localStorage.setItem('dartsStats', JSON.stringify(state.stats));
                },
                load: () => {
                    state.history = JSON.parse(localStorage.getItem('dartsHistory')) || [];
                    state.stats = JSON.parse(localStorage.getItem('dartsStats')) || {
                        bestLeg: null,
                        bestSessionAvg: 0,
                        total180s: 0,
                    };
                },
                getCheckout: (score) => {
                    if (score > 170 || score < 2) return '';
                    if (bogeyNumbers.includes(score)) return '';
                    return checkoutTable[score] || '';
                },
                isBogey: (score) => {
                    return bogeyNumbers.includes(score);
                },
                formatAvg: (avg) => isNaN(avg) ? '0.00' : avg.toFixed(2),
                updateSessionAvg: () => {
                    if (state.session.totalDarts > 0) {
                        state.session.sessionAvg = (state.session.totalScore / state.session.totalDarts) * 3;
                    } else {
                        state.session.sessionAvg = 0;
                    }
                },
                updateCheckoutPct: () => {
                    const totalAttempts = state.session.checkoutsHit + state.session.checkoutsMissed;
                    if (totalAttempts === 0) return '0%';
                    return `${Math.round((state.session.checkoutsHit / totalAttempts) * 100)}%`;
                },
                showModal: (modal) => modal.classList.remove('hidden'),
                hideModal: (modal) => modal.classList.add('hidden'),
                showGameOver: (title, message) => {
                    displays.gameOverTitle.textContent = title;
                    displays.gameOverMessage.textContent = message;
                    utils.showModal(displays.gameOverModal);
                }
            };

            // --- Render Functions ---
            const render = {
                all: () => {
                    render.view();
                    render.keypad();
                    render.playerScore();
                    render.botScore();
                    render.legStats();
                    render.sessionStats();
                    render.legHistory();
                    render.gameModeUI();
                    render.statsPage();
                },
                view: () => {
                    Object.values(views).forEach(v => v.classList.add('hidden'));
                    Object.values(tabs).forEach(t => t.classList.remove('active'));
                    views[state.currentView].classList.remove('hidden');
                    tabs[state.currentView].classList.add('active');
                },
                keypad: () => {
                    displays.keypad.textContent = state.keypadBuffer;
                },
                playerScore: () => {
                    if (state.gameMode === '501' || state.gameMode.startsWith('bot-')) {
                        const score = state.player.score;
                        displays.playerScore.textContent = score;
                        const checkout = utils.getCheckout(score);
                        displays.playerCheckout.textContent = checkout;
                        displays.playerBogey.textContent = utils.isBogey(score) ? 'Bogey Number!' : '';
                    }
                },
                botScore: () => {
                    if (state.gameMode.startsWith('bot-')) {
                        displays.botContainer.classList.remove('hidden');
                        displays.botScore.textContent = state.bot.score;
                        displays.botLabel.textContent = `BOT (${state.bot.targetAverage} Avg)`;
                    } else {
                        displays.botContainer.classList.add('hidden');
                    }
                },
                legStats: () => {
                    const avg = state.player.dartsThrown > 0 ? (501 - state.player.score) / state.player.dartsThrown * 3 : 0;
                    displays.legAvg.textContent = utils.formatAvg(avg);
                    displays.legDarts.textContent = state.player.dartsThrown;
                },
                sessionStats: () => {
                    displays.sessionAvg.textContent = utils.formatAvg(state.session.sessionAvg);
                    displays.sessionLegs.textContent = state.session.legsPlayed;
                    displays.sessionBest.textContent = state.session.bestLeg ? `${state.session.bestLeg}` : '-';
                    displays.sessionCheckoutPct.textContent = utils.updateCheckoutPct();
                },
                legHistory: () => {
                    displays.legHistoryList.innerHTML = state.player.legHistory
                        .map(turn => `<li class="border-b border-gray-700 last:border-b-0 py-1">Turn ${turn.turn}: <strong>${turn.score}</strong> (${turn.left} left)</li>`)
                        .reverse()
                        .join('');
                    // Scroll to bottom
                    displays.legHistoryContainer.scrollTop = displays.legHistoryContainer.scrollHeight;
                },
                gameModeUI: () => {
                    // Hide all special UI first
                    [displays.playerScoreContainer, displays.legStatsContainer, displays.legHistoryContainer].forEach(el => el.classList.remove('hidden'));
                    [displays.checkoutPracticeDisplay, displays.atcDisplay, displays.bobs27Display].forEach(el => el.classList.add('hidden'));
                    displays.playerLabel.textContent = 'YOU';
                    displays.keypadEnter.textContent = 'ENTER';
                    displays.keypadBust.textContent = 'BUST';
                    displays.keypadUndo.disabled = false;

                    switch (state.gameMode) {
                        case '501':
                        case 'bot-50':
                        case 'bot-65':
                        case 'bot-80':
                        case 'bot-custom': // Added this
                            // This is the default, so nothing to do
                            break;
                        case 'checkout':
                            [displays.legStatsContainer, displays.legHistoryContainer, displays.botContainer].forEach(el => el.classList.add('hidden'));
                            displays.checkoutPracticeDisplay.classList.remove('hidden');
                            displays.playerScore.textContent = state.checkoutPractice.target;
                            displays.playerCheckout.textContent = utils.getCheckout(state.checkoutPractice.target);
                            displays.playerBogey.textContent = '';
                            displays.playerLabel.textContent = 'PRACTICE CHECKOUT';
                            displays.checkoutDartsThrown.textContent = `Darts Thrown: ${state.checkoutPractice.dartsThrown}`;
                            break;
                        case 'atc':
                            [displays.playerScoreContainer, displays.legStatsContainer, displays.legHistoryContainer, displays.botContainer].forEach(el => el.classList.add('hidden'));
                            displays.atcDisplay.classList.remove('hidden');
                            displays.atcTarget.textContent = state.atc.target === 21 ? 'BULL' : `D${state.atc.target}`;
                            displays.atcDarts.textContent = `Total Darts: ${state.atc.dartsThrown}`;
                            displays.keypadEnter.textContent = 'HIT';
                            displays.keypadBust.textContent = 'MISS';
                            displays.keypadUndo.disabled = true;
                            break;
                        case 'bobs27':
                            [displays.playerScoreContainer, displays.legStatsContainer, displays.legHistoryContainer, displays.botContainer].forEach(el => el.classList.add('hidden'));
                            displays.bobs27Display.classList.remove('hidden');
                            displays.bobs27Score.textContent = state.bobs27.score;
                            displays.bobs27Target.textContent = state.bobs27.target === 21 ? 'BULL' : `D${state.bobs27.target}`;
                            displays.keypadUndo.disabled = true;
                            break;
                    }
                },
                statsPage: () => {
                    if (state.currentView !== 'stats') return;
                    
                    displays.bestLeg.textContent = state.stats.bestLeg ? `${state.stats.bestLeg}` : '-';
                    displays.bestSession.textContent = utils.formatAvg(state.stats.bestSessionAvg);
                    displays.total180s.textContent = state.stats.total180s;
                    
                    // Render table
                    displays.historyTableBody.innerHTML = state.history
                        .map(s => `
                            <tr class="border-b border-gray-700 last:border-b-0">
                                <td class="py-2">${new Date(s.date).toLocaleDateString()}</td>
                                <td class="py-2">${utils.formatAvg(s.sessionAvg)}</td>
                                <td class="py-2">${s.bestLeg || '-'}</td>
                                <td class="py-2">${s.checkoutPct}</td>
                            </tr>
                        `).reverse().join('');
                    
                    // Render chart
                    render.chart();
                },
                chart: () => {
                    if (state.chart) {
                        state.chart.destroy();
                    }
                    const ctx = $('#stats-chart').getContext('2d');
                    const labels = state.history.map(s => new Date(s.date).toLocaleDateString());
                    const avgData = state.history.map(s => s.sessionAvg);
                    const checkoutData = state.history.map(s => parseFloat(s.checkoutPct));

                    state.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Session Average',
                                    data: avgData,
                                    borderColor: '#facc15', // yellow-400
                                    backgroundColor: '#facc1533',
                                    fill: false,
                                    yAxisID: 'yAvg',
                                },
                                {
                                    label: 'Checkout %',
                                    data: checkoutData,
                                    borderColor: '#4ade80', // green-400
                                    backgroundColor: '#4ade8033',
                                    fill: false,
                                    yAxisID: 'yPct',
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { labels: { color: '#d1d5db' } }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#9ca3af' },
                                    grid: { color: '#374151' }
                                },
                                yAvg: {
                                    type: 'linear',
                                    position: 'left',
                                    ticks: { color: '#facc15' },
                                    grid: { color: '#374151' },
                                    title: {
                                        display: true,
                                        text: 'Average',
                                        color: '#facc15'
                                    }
                                },
                                yPct: {
                                    type: 'linear',
                                    position: 'right',
                                    min: 0,
                                    max: 100,
                                    ticks: { color: '#4ade80', callback: (value) => value + '%' },
                                    grid: { drawOnChartArea: false },
                                    title: {
                                        display: true,
                                        text: 'Checkout %',
                                        color: '#4ade80'
                                    }
                                }
                            }
                        }
                    });
                }
            };

            // --- Game Logic ---
            const game = {
                init: () => {
                    utils.load();
                    game.newSession();
                    game.startMode(state.gameMode);
                    render.all();
                },
                newSession: () => {
                    state.session = {
                        legsPlayed: 0,
                        totalDarts: 0,
                        totalScore: 0,
                        sessionAvg: 0,
                        bestLeg: null,
                        checkoutsHit: 0,
                        checkoutsMissed: 0,
                    };
                },
                startMode: (mode) => {
                    state.gameMode = mode;
                    state.keypadBuffer = '';
                    state.lastTurn = null;

                    if (mode === '501' || mode.startsWith('bot-')) {
                        game.startLeg(); // This function now handles bot setup
                    } else if (mode === 'checkout') {
                        game.startCheckoutPractice();
                    } else if (mode === 'atc') {
                        game.startAtc();
                    } else if (mode === 'bobs27') {
                        game.startBobs27();
                    }
                    render.all();
                },
                startLeg: () => {
                    state.player = {
                        score: 501,
                        dartsThrown: 0,
                        legHistory: [],
                    };
                    
                    // === FIX WAS HERE ===
                    // Initialize or reset the bot *inside* startLeg
                    if (state.gameMode.startsWith('bot-')) {
                        let avg;
                        if (state.gameMode === 'bot-custom') {
                            avg = parseInt($('#bot-avg').value) || 65; // Use 65 as fallback
                        } else {
                            avg = parseInt(state.gameMode.split('-')[1]);
                        }
                        
                        if (!state.bot) {
                            // Create bot if it doesn't exist
                            state.bot = {
                                score: 501,
                                dartsThrown: 0,
                                targetAverage: avg,
                            };
                        } else {
                            // Just reset score/darts if it does
                            state.bot.score = 501;
                            state.bot.dartsThrown = 0;
                            state.bot.targetAverage = avg; // Ensure average is updated
                        }
                    }
                    // === END FIX ===

                    state.keypadBuffer = '';
                    state.lastTurn = null;
                },
                startCheckoutPractice: () => {
                    let target = 0;
                    while (target === 0 || utils.isBogey(target) || !utils.getCheckout(target)) {
                        target = Math.floor(Math.random() * (170 - 41 + 1)) + 41; // 41 to 170
                    }
                    state.checkoutPractice = {
                        target: target,
                        dartsThrown: 0,
                    };
                },
                startAtc: () => {
                    state.atc = {
                        target: 1,
                        dartsThrown: 0,
                        missesInARow: 0,
                    };
                },
                startBobs27: () => {
                    state.bobs27 = {
                        score: 27,
                        target: 1,
                    };
                },
                enterScore: () => {
                    const score = parseInt(state.keypadBuffer);
                    if (isNaN(score)) return;

                    // Save state for undo
                    state.lastTurn = {
                        player: JSON.parse(JSON.stringify(state.player)),
                        bot: state.bot ? JSON.parse(JSON.stringify(state.bot)) : null,
                        session: JSON.parse(JSON.stringify(state.session)),
                    };

                    // --- 501 / Bot-501 Logic ---
                    if (state.gameMode === '501' || state.gameMode.startsWith('bot-')) {
                        if (score > 180 || score > state.player.score || (state.player.score - score) === 1) {
                            game.bust();
                            return;
                        }

                        state.player.score -= score;
                        state.player.dartsThrown += 3;
                        state.player.legHistory.push({ turn: Math.floor(state.player.dartsThrown / 3), score: score, left: state.player.score });
                        
                        if (score === 180) {
                            state.stats.total180s++;
                        }
                        
                        // Check for win
                        if (state.player.score === 0) {
                            // Check for valid checkout (TODO: requires double-out validation, simple for now)
                            displays.checkoutLegDarts.textContent = `Leg finished in ${state.player.dartsThrown} darts!`;
                            utils.showModal(displays.checkoutModal);
                        } else {
                            // Bot's turn
                            if (state.gameMode.startsWith('bot-')) {
                                setTimeout(game.botTurn, 500);
                            }
                        }
                    }
                    // --- Checkout Practice Logic ---
                    else if (state.gameMode === 'checkout') {
                        state.checkoutPractice.dartsThrown += 3;
                        if (score === state.checkoutPractice.target) {
                            utils.showGameOver('Target Hit!', `You hit ${state.checkoutPractice.target} in ${state.checkoutPractice.dartsThrown} darts.`);
                            // Here you could track checkout % for practice
                        } else if (score > state.checkoutPractice.target || (state.checkoutPractice.target - score) === 1) {
                            utils.showGameOver('Bust!', 'You busted the target. Try again.');
                        } else {
                            state.checkoutPractice.target -= score;
                        }
                    }
                    // --- Bob's 27 Logic ---
                    else if (state.gameMode === 'bobs27') {
                        if (score < 0 || score > 3) return; // Only 0-3 hits
                        const targetVal = state.bobs27.target === 21 ? 50 : state.bobs27.target * 2; // Handle Bull
                        if (score === 0) {
                            state.bobs27.score -= targetVal;
                        } else {
                            state.bobs27.score += (targetVal * score);
                        }
                        
                        if (state.bobs27.score <= 0) {
                            utils.showGameOver('Game Over!', `You went bust on ${state.bobs27.target === 21 ? 'Bull' : `D${state.bobs27.target}`}.`);
                        } else {
                            state.bobs27.target++;
                            if (state.bobs27.target > 21) { // 21 is Bull
                                utils.showGameOver('Congratulations!', `You finished Bob's 27 with a score of ${state.bobs27.score}!`);
                            }
                        }
                    }
                    
                    state.keypadBuffer = '';
                    render.all();
                },
                bust: () => {
                    // Save state for undo
                    state.lastTurn = {
                        player: JSON.parse(JSON.stringify(state.player)),
                        bot: state.bot ? JSON.parse(JSON.stringify(state.bot)) : null,
                        session: JSON.parse(JSON.stringify(state.session)),
                    };
                    
                    if (state.gameMode === '501' || state.gameMode.startsWith('bot-')) {
                        state.player.dartsThrown += 3;
                        state.player.legHistory.push({ turn: Math.floor(state.player.dartsThrown / 3), score: 'BUST', left: state.player.score });

                        if (state.gameMode.startsWith('bot-')) {
                            setTimeout(game.botTurn, 500);
                        }
                    }
                    else if (state.gameMode === 'checkout') {
                        state.checkoutPractice.dartsThrown += 3;
                        utils.showGameOver('Bust!', 'You busted the target. Try again.');
                    }
                    
                    state.keypadBuffer = '';
                    render.all();
                },
                undo: () => {
                    if (state.lastTurn) {
                        state.player = state.lastTurn.player;
                        state.bot = state.lastTurn.bot;
                        state.session = state.lastTurn.session;
                        state.lastTurn = null;
                        render.all();
                    }
                },
                atcLogic: (hit) => {
                    state.atc.dartsThrown++;
                    if (hit) {
                        state.atc.target++;
                        state.atc.missesInARow = 0;
                        if (state.atc.target > 21) { // 21 = Bull
                            utils.showGameOver('Finished!', `You completed Around the Clock in ${state.atc.dartsThrown} darts!`);
                        }
                    } else {
                        state.atc.missesInARow++;
                        if (state.atc.missesInARow === 3) {
                            state.atc.target++;
                            state.atc.missesInARow = 0;
                            if (state.atc.target > 21) {
                                utils.showGameOver('Finished!', `You completed Around the Clock in ${state.atc.dartsThrown} darts!`);
                            }
                        }
                    }
                    render.all();
                },
                botTurn: () => {
                    if (!state.bot || state.bot.score === 0 || state.player.score === 0) return;

                    let score = 0;
                    const avg = state.bot.targetAverage;

                    // Simple checkout logic
                    const botCheckout = utils.getCheckout(state.bot.score);
                    if (botCheckout) {
                        // Give bot a chance to win based on average
                        const checkoutChance = avg / 250; // e.g., 80 avg = 32% chance
                        if (Math.random() < checkoutChance) {
                            score = state.bot.score;
                        } else {
                            // Missed checkout, score something sensible
                            score = Math.floor(Math.random() * (avg * 0.5)) + (avg * 0.2); // Score low-ish
                            score = Math.min(score, state.bot.score - 2); // Don't bust
                            score = Math.max(0, score); // Ensure score is not negative
                        }
                    } else {
                        // Normal scoring
                        const variance = 0.4;
                        score = Math.floor(avg * (1 - variance / 2) + Math.random() * (avg * variance));
                        score = Math.max(0, Math.min(180, score)); // Clamp 0-180
                    }

                    // Check for bust
                    if (score > state.bot.score || (state.bot.score - score) === 1) {
                        score = 0; // Bot busted
                    }
                    
                    state.bot.score -= score;
                    state.bot.dartsThrown += 3;

                    if (state.bot.score === 0) {
                        utils.showGameOver('You Lose!', `Bot won in ${state.bot.dartsThrown} darts.`);
                    }
                    render.botScore();
                },
                finishLeg: (dartsAtDouble) => {
                    // Update session stats
                    state.session.legsPlayed++;
                    state.session.totalDarts += state.player.dartsThrown;
                    state.session.totalScore += 501;
                    
                    if (!state.session.bestLeg || state.player.dartsThrown < state.session.bestLeg) {
                        state.session.bestLeg = state.player.dartsThrown;
                    }

                    // Update global stats
                    if (!state.stats.bestLeg || state.player.dartsThrown < state.stats.bestLeg) {
                        state.stats.bestLeg = state.player.dartsThrown;
                    }

                    // Checkout stats
                    state.session.checkoutsHit++;
                    state.session.checkoutsMissed += (dartsAtDouble - 1);
                    
                    utils.updateSessionAvg();
                    
                    if (state.session.sessionAvg > state.stats.bestSessionAvg) {
                        state.stats.bestSessionAvg = state.session.sessionAvg;
                    }

                    // Save session to history
                    const today = new Date().toISOString().split('T')[0];
                    const todayHistory = state.history.find(s => s.date === today);
                    const currentCheckoutPct = utils.updateCheckoutPct();

                    if (todayHistory) {
                        // Update today's entry
                        todayHistory.sessionAvg = (todayHistory.sessionAvg * todayHistory.legsPlayed + state.session.sessionAvg) / (todayHistory.legsPlayed + 1); // Re-average
                        todayHistory.legsPlayed++;
                        todayHistory.bestLeg = Math.min(todayHistory.bestLeg || 999, state.session.bestLeg);
                        todayHistory.checkoutPct = currentCheckoutPct; // Just use latest
                    } else {
                        // Add new entry
                        state.history.push({
                            date: today,
                            sessionAvg: state.session.sessionAvg,
                            bestLeg: state.session.bestLeg,
                            checkoutPct: currentCheckoutPct,
                            legsPlayed: 1,
                        });
                    }

                    utils.save();
                    utils.hideModal(displays.checkoutModal);
                    game.startLeg();
                    render.all();
                }
            };

            // --- Event Handlers ---
            const handlers = {
                onTabClick: (e) => {
                    const view = e.target.dataset.view;
                    if (view) {
                        state.currentView = view;
                        render.all();
                    }
                },
                onFullscreenToggle: () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                },
                updateFullscreenIcon: () => {
                    const expandIcon = $('#fs-icon-expand');
                    const collapseIcon = $('#fs-icon-collapse');
                    if (document.fullscreenElement) {
                        expandIcon.classList.add('hidden');
                        collapseIcon.classList.remove('hidden');
                    } else {
                        expandIcon.classList.remove('hidden');
                        collapseIcon.classList.add('hidden');
                    }
                },

                // --- START BUG FIX & NEW FEATURE ---
                onKeypadClick: (e) => {
                    const key = e.target.dataset.key;
                    if (key && state.keypadBuffer.length < 3) {
                        state.keypadBuffer += key;
                        render.keypad();
                    }
                },
                onClear: () => {
                    state.keypadBuffer = '';
                    render.keypad();
                },
                onEnter: () => {
                    if (state.gameMode === 'atc') {
                        game.atcLogic(true);
                    } else {
                        game.enterScore();
                    }
                },
                onBust: () => {
                    if (state.gameMode === 'atc') {
                        game.atcLogic(false);
                    } else {
                        game.bust();
                    }
                },
                onModeChange: (e) => {
                    const newMode = e.target.value;
                    // Show/Hide custom bot average input
                    if (newMode === 'bot-custom') {
                        $('#bot-avg-container').classList.remove('hidden');
                    } else {
                        $('#bot-avg-container').classList.add('hidden');
                    }
                    game.startMode(newMode);
                },
                onSaveCheckout: () => {
                    const darts = parseInt(displays.dartsAtDoubleInput.value) || 1;
                    game.finishLeg(darts);
                },
                onGameOverOk: () => {
                    utils.hideModal(displays.gameOverModal);
                    game.startMode(state.gameMode); // Restart current mode
                },
                onClearHistory: () => {
                    // Use a simple custom confirmation modal instead of window.confirm
                    utils.showGameOver('Confirm', 'Delete all history? This cannot be undone.');
                    
                    // Re-purpose the OK button for this action
                    const okBtn = displays.gameOverOkBtn;

                    // Clone and replace to remove all old listeners and prevent stacking
                    const newOkBtn = okBtn.cloneNode(true);
                    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                    newOkBtn.textContent = 'Yes, Delete All'; // Clarify button action
                    
                    newOkBtn.addEventListener('click', () => {
                        // Perform the delete action
                        localStorage.removeItem('dartsHistory');
                        localStorage.removeItem('dartsStats');
                        game.init(); // Re-initialize the app state
                        utils.hideModal(displays.gameOverModal);
                        
                        // Restore original button text and event listener
                        const originalOkBtn = newOkBtn.cloneNode(true);
                        newOkBtn.parentNode.replaceChild(originalOkBtn, newOkBtn);
                        originalOkBtn.textContent = 'New Game';
                        originalOkBtn.addEventListener('click', handlers.onGameOverOk);
                        
                        // Re-assign the DOM element in the 'displays' object
                        displays.gameOverOkBtn = originalOkBtn;
                    
                    }, { once: true }); // <-- Added { once: true } and the correct closing );
                    
                    // Re-assign the DOM element in the 'displays' object
                    displays.gameOverOkBtn = newOkBtn;

                }, // <-- Correctly closes onClearHistory
                
                onCustomAvgChange: (e) => { // <-- Moved this function to be a property of 'handlers'
                    if (state.gameMode === 'bot-custom') {
                        // Restart the leg with the new average
                        game.startMode('bot-custom');
                    }
                }
                // --- END BUG FIX & NEW FEATURE ---
            }; // <-- This closes the handlers object

            // --- Init ---
            // Keypad
            $$('.keypad-btn[data-key]').forEach(btn => btn.addEventListener('click', handlers.onKeypadClick));
            $('#keypad-clear').addEventListener('click', handlers.onClear);
            displays.keypadEnter.addEventListener('click', handlers.onEnter);
            displays.keypadBust.addEventListener('click', handlers.onBust);
            displays.keypadUndo.addEventListener('click', game.undo);
            
            // Tabs
            $('#tab-game').addEventListener('click', handlers.onTabClick);
            $('#tab-stats').addEventListener('click', handlers.onTabClick);
            
            // Mode
            displays.gameModeSelect.addEventListener('change', handlers.onModeChange);
            $('#bot-avg').addEventListener('change', handlers.onCustomAvgChange);
            
            // Modals
            displays.saveCheckoutBtn.addEventListener('click', handlers.onSaveCheckout);
            displays.gameOverOkBtn.addEventListener('click', handlers.onGameOverOk);
            
            // Stats
            $('#clear-history-btn').addEventListener('click', handlers.onClearHistory);

            // Fullscreen
            $('#fullscreen-btn').addEventListener('click', handlers.onFullscreenToggle);
            document.addEventListener('fullscreenchange', handlers.updateFullscreenIcon);

            // Start the app
            game.init();

            // --- PWA: Register Service Worker ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }
            // --- End PWA ---
        });
    </script>
</body>
</html>